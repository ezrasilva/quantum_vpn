services:
  # --- VPN ALICE ---
  alice:
    build: .
    container_name: alice
    cap_add: [NET_ADMIN, SYS_MODULE]
    networks:
      rede_a:
        ipv4_address: 10.100.1.10
      rede_b:
        ipv4_address: 10.100.2.11
    volumes:
      - ./alice/swanctl.conf:/etc/swanctl/swanctl.conf
      - ./scripts:/scripts  # Para acessar o vpn_agent.py

    entrypoint: ["/entrypoint.sh"]

  # --- VPN BOB ---
  bob:
    build: .
    container_name: bob
    cap_add: [NET_ADMIN, SYS_MODULE]
    networks:
      rede_a:
        ipv4_address: 10.100.1.11
      rede_b:
        ipv4_address: 10.100.2.10
    volumes:
      - ./bob/swanctl.conf:/etc/swanctl/swanctl.conf
      - ./scripts:/scripts
    entrypoint: ["/entrypoint.sh"]

  # --- VPN CAROL ---
  carol:
    build: .
    container_name: carol
    cap_add: [NET_ADMIN, SYS_MODULE]
    networks:
      rede_a:
        ipv4_address: 10.100.1.12
      rede_b:
        ipv4_address: 10.100.2.12
    volumes:
      - ./carol/swanctl.conf:/etc/swanctl/swanctl.conf
      - ./scripts:/scripts
    entrypoint: ["/entrypoint.sh"]

  # --- VPN DAVE ---
  dave:
    build: .
    container_name: dave
    cap_add: [NET_ADMIN, SYS_MODULE]
    networks:
      rede_a:
        ipv4_address: 10.100.1.13
      rede_b:
        ipv4_address: 10.100.2.13
    volumes:
      - ./dave/swanctl.conf:/etc/swanctl/swanctl.conf
      - ./scripts:/scripts
    entrypoint: ["/entrypoint.sh"]

  # --- ORQUESTRADOR (O CÃ‰REBRO) ---
  orchestrator:
    build: .  # Usa a mesma imagem com Python + LibOQS + VICI
    container_name: orchestrator
    networks:
      vpc_qkd:
        ipv4_address: 10.5.0.99
      rede_a:
        ipv4_address: 10.100.1.40
      rede_b:
        ipv4_address: 10.100.2.40
    volumes:
      - ./scripts:/scripts
    # Executa o controlador SDN
    entrypoint: ["python3", "/scripts/sdn_controller_multi_node.py"]


networks:
  vpc_qkd:
    driver: bridge
    ipam:
      config:
        - subnet: 10.5.0.0/24
  rede_a:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "false"
    ipam:
      config:
        - subnet: 10.100.1.0/24
  rede_b:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "false"
    ipam:
      config:
        - subnet: 10.100.2.0/24
 