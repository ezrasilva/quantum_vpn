services:
  # --- VPN ALICE ---
  alice:
    build: .
    container_name: alice
    cap_add: [NET_ADMIN, SYS_MODULE]
    networks:
      rede_a:
        ipv4_address: 10.100.1.10
      rede_b:
        ipv4_address: 10.100.2.11
    volumes:
      - ./alice/swanctl.conf:/etc/swanctl/swanctl.conf
      - ./scripts:/scripts  # Para acessar o vpn_agent.py

    entrypoint: ["/entrypoint.sh"]

  # --- VPN BOB ---
  bob:
    build: .
    container_name: bob
    cap_add: [NET_ADMIN, SYS_MODULE]
    networks:
      rede_a:
        ipv4_address: 10.100.1.11
      rede_b:
        ipv4_address: 10.100.2.10
    volumes:
      - ./bob/swanctl.conf:/etc/swanctl/swanctl.conf
      - ./scripts:/scripts
    entrypoint: ["/entrypoint.sh"]
  # --- ORQUESTRADOR (O CÉREBRO) ---
  orchestrator:
    build: .  # Usa a mesma imagem com Python + LibOQS + VICI
    container_name: orchestrator
    networks:
      vpc_qkd:
        ipv4_address: 10.5.0.99
      rede_a:
        ipv4_address: 10.100.1.40
      rede_b:
        ipv4_address: 10.100.2.40
    volumes:
      - ./scripts:/scripts
    # Mantém rodando para entrarmos depois
    command: tail -f /dev/null

  gateway:
    image: ubuntu:22.04
    container_name: gateway
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    sysctls:
      net.ipv4.ip_forward: "1"
      net.ipv4.conf.all.proxy_arp: "1"
    command: sh -c "apt-get update && apt-get install -y iproute2 iptables iputils-ping iproute2-tc && tc qdisc add dev eth0 root netem delay 20ms 5ms && tc qdisc add dev eth1 root netem delay 20ms 5ms && sleep infinity"
    networks:
      rede_a:
        ipv4_address: 10.100.1.254
      rede_b:
        ipv4_address: 10.100.2.254

networks:
  vpc_qkd:
    driver: bridge
    ipam:
      config:
        - subnet: 10.5.0.0/24
  rede_a:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "false"
    ipam:
      config:
        - subnet: 10.100.1.0/24
  rede_b:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "false"
    ipam:
      config:
        - subnet: 10.100.2.0/24
 